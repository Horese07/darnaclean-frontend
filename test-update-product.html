<!DOCTYPE html>
<html>
<head>
    <title>Test API Mise √† Jour Produit</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 20px 0; padding: 15px; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .debug-info { background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .api-test { background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 3px; }
        label { font-weight: bold; display: block; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Test API Mise √† Jour Produit</h1>
    
    <div class="test-section">
        <h3>1. R√©cup√©rer un produit existant</h3>
        <button onclick="getProducts()">R√©cup√©rer les produits</button>
        <div id="products-result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. Formulaire de mise √† jour</h3>
        <div id="update-form" style="display: none;">
            <label>ID du produit:</label>
            <input type="text" id="product-id" readonly />
            
            <label>Nom (FR):</label>
            <input type="text" id="name-fr" placeholder="Nom en fran√ßais" />
            
            <label>Nom (EN):</label>
            <input type="text" id="name-en" placeholder="Nom en anglais" />
            
            <label>Nom (AR):</label>
            <input type="text" id="name-ar" placeholder="Nom en arabe" />
            
            <label>Description (FR):</label>
            <textarea id="desc-fr" placeholder="Description en fran√ßais"></textarea>
            
            <label>Prix:</label>
            <input type="number" id="price" step="0.01" placeholder="0.00" />
            
            <label>Stock:</label>
            <input type="number" id="stock" placeholder="0" />
            
            <label>Cat√©gorie ID:</label>
            <input type="number" id="category-id" placeholder="1" />
            
            <button onclick="updateProduct()" style="background: #28a745;">Mettre √† jour le produit</button>
        </div>
    </div>
    
    <div class="test-section">
        <h3>3. R√©sultat de la mise √† jour</h3>
        <div id="update-result"></div>
    </div>

    <script>
        let currentProduct = null;

        async function getProducts() {
            const resultDiv = document.getElementById('products-result');
            resultDiv.innerHTML = 'R√©cup√©ration en cours...';

            try {
                const response = await fetch('http://localhost:8000/api/v1/products');
                const data = await response.json();

                if (data.success && data.data && data.data.length > 0) {
                    currentProduct = data.data[0]; // Prendre le premier produit
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Produit r√©cup√©r√© !<br>
                            <strong>ID:</strong> ${currentProduct.id}<br>
                            <strong>Nom (FR):</strong> ${currentProduct.name_fr || 'N/A'}<br>
                            <strong>Prix:</strong> ${currentProduct.price}<br>
                            <strong>Stock:</strong> ${currentProduct.stock}<br>
                            <strong>Cat√©gorie ID:</strong> ${currentProduct.category_id}
                        </div>
                        
                        <div class="debug-info">
                            <strong>Structure compl√®te:</strong><br>
                            <pre>${JSON.stringify(currentProduct, null, 2)}</pre>
                        </div>
                    `;

                    // Afficher le formulaire de mise √† jour
                    document.getElementById('update-form').style.display = 'block';
                    
                    // Remplir le formulaire
                    document.getElementById('product-id').value = currentProduct.id;
                    document.getElementById('name-fr').value = currentProduct.name_fr || '';
                    document.getElementById('name-en').value = currentProduct.name_en || '';
                    document.getElementById('name-ar').value = currentProduct.name_ar || '';
                    document.getElementById('desc-fr').value = currentProduct.description_fr || '';
                    document.getElementById('price').value = currentProduct.price || '';
                    document.getElementById('stock').value = currentProduct.stock || '';
                    document.getElementById('category-id').value = currentProduct.category_id || '';

                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå Aucun produit trouv√© ou structure inattendue<br>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Erreur: ${error.message}
                    </div>
                `;
            }
        }

        async function updateProduct() {
            if (!currentProduct) {
                alert('Veuillez d\'abord r√©cup√©rer un produit');
                return;
            }

            const resultDiv = document.getElementById('update-result');
            resultDiv.innerHTML = 'Mise √† jour en cours...';

            try {
                // Pr√©parer les donn√©es
                const updateData = {
                    name: {
                        fr: document.getElementById('name-fr').value,
                        en: document.getElementById('name-en').value,
                        ar: document.getElementById('name-ar').value
                    },
                    description: {
                        fr: document.getElementById('desc-fr').value,
                        en: document.getElementById('desc-fr').value, // Copier le fran√ßais pour l'anglais
                        ar: document.getElementById('desc-fr').value  // Copier le fran√ßais pour l'arabe
                    },
                    price: parseFloat(document.getElementById('price').value),
                    stock: parseInt(document.getElementById('stock').value),
                    category_id: parseInt(document.getElementById('category-id').value),
                    currency: 'MAD',
                    is_active: true
                };

                console.log('üîç Donn√©es √† envoyer:', updateData);

                const response = await fetch(`http://localhost:8000/api/v1/products/${currentProduct.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                console.log('üì• R√©ponse re√ßue:', response);
                console.log('üìä Status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Mise √† jour r√©ussie:', result);
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Produit mis √† jour avec succ√®s !<br>
                            <strong>Message:</strong> ${result.message}<br>
                            <strong>ID:</strong> ${result.data.id}<br>
                            <strong>Nom (FR):</strong> ${result.data.name_fr || result.data.name?.fr || 'N/A'}<br>
                            <strong>Prix:</strong> ${result.data.price}<br>
                            <strong>Stock:</strong> ${result.data.stock}
                        </div>
                        
                        <div class="debug-info">
                            <strong>R√©ponse compl√®te:</strong><br>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    `;

                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Erreur de r√©ponse:', errorText);
                    
                    let errorMessage = 'Erreur inconnue';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || errorData.error || errorMessage;
                    } catch (parseError) {
                        errorMessage = `Erreur ${response.status}: ${errorText}`;
                    }
                    
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå Erreur lors de la mise √† jour<br>
                            <strong>Status:</strong> ${response.status}<br>
                            <strong>Message:</strong> ${errorMessage}<br>
                            <strong>R√©ponse brute:</strong><br>
                            <pre>${errorText}</pre>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('‚ùå Erreur r√©seau:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        ‚ùå Erreur r√©seau: ${error.message}
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
